<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>D3 Test</title>
	<script src="d3/d3.min.js"></script>
	<script src="https://d3js.org/topojson.v1.min.js"></script>
	<style>
		* {
			margin: 0;
			padding: 0;
		}

		body {
			background-color: #eee;
		}

		svg {
			position: absolute;
			width: 100%;
			height: 100%;
		}

		.background {
			fill: #eee;
			pointer-events: all;
		}

		#zones {
			fill: #555;
		}

		#zones .active {
			fill: #55a;
		}

		#zone-borders {
		  fill: none;
		  stroke: #fff;
		  stroke-width: 1px;
		  stroke-linejoin: round;
		  stroke-linecap: round;
		  pointer-events: none;
	    }

		#ids {
			fill: #fff;
			font-family: helvetica;
			font-size: 10px;
			text-anchor: middle;
			opacity: .75;
		}

		#moused-zone {
			fill: #5a5;
		}

		.category-text {
			font-family: Roboto;
			fill: #55f;
			font-size: 36px;
		}

		.min-text, .max-text {
			font-family: Roboto;
			fill: black;
			font-size: 15px;
		}
	</style>
</head>
<body>
	<form>
		<input type="checkbox" name="" value="elev">elev
		<input type="checkbox" name="" value="Temp">Temp
		<input type="checkbox" name="" value="TempC">TempC
		<input type="checkbox" name="" value="Dewp">Dewp
		<input type="checkbox" name="" value="Relh">Relh
		<input type="checkbox" name="" value="Winds">Winds
		<input type="checkbox" name="" value="SLP">SLP
		<input type="checkbox" name="" value="Altimeter">Altimeter
		<input type="checkbox" name="" value="Visibility">Visibility
		<input type="checkbox" name="" value="TempHi24">TempHi24
		<input type="checkbox" name="" value="TempLo24">TempLo24
		<input type="checkbox" name="" value="RelhHi24">RelhHi24
		<input type="checkbox" name="" value="RelhLo24">RelhLo24
		<input type="checkbox" name="" value="GustHi24">GustHi24
		<input type="checkbox" name="" value="RawsTemp12">RawsTemp12
		<input type="checkbox" name="" value="RawsTemp13">RawsTemp13
		<input type="checkbox" name="" value="RawsTemp14">RawsTemp14
		<input type="checkbox" name="" value="RawsRelh12">RawsRelh12
		<input type="checkbox" name="" value="RawsRelh13">RawsRelh13
		<input type="checkbox" name="" value="RawsRelh14">RawsRelh14<br>
		<input type="button" value="Update" onclick="updateCategories()">
	</form>

	<script>
		//set up variables and functions we will need
		var width = window.innerWidth,
			height = window.innerHeight;

		var projectionFunc = d3.geo.mercator()	//world
			.scale(7000)
			.center([-119.6, 36.3])	//hnx coords
			.translate([width/2, height/2]);

		var pathFunc = d3.geo.path()
			.projection(projectionFunc);

		var svg = d3.select("body").append("svg")
			.attr("width", width)
			.attr("height", height);

		//get hnx map data and plot it
		d3.json("hnxSaZones.json", function(error, hnx) {
			if (error) throw error;

			var zones = topojson.feature(hnx, hnx.objects.hnxsaZones).features;
			svg.selectAll("path")
					.data(zones)
				.enter()
					.append("path")
					.attr("id", "zones")
					.attr("d", pathFunc);

			//make borders separately so they dont slow it down
			svg.append("path")
		        .datum(topojson.mesh(hnx, hnx.objects.hnxsaZones, function(a, b) {
				    return a !== b;
			    }))
		        .attr("id", "zone-borders")
		        .attr("d", pathFunc);

			//label zones
			svg.selectAll("text")
				.data(zones)
			  .enter().append("text")
			  	.attr("id", "ids")
				.attr("x", function(d) {
					return projectionFunc([d.properties.LON, d.properties.LAT])[0];
				})
				.attr("y", function(d) {
					return projectionFunc([d.properties.LON, d.properties.LAT])[1];
				})
				.text(function(d) {
					return d.properties.ZONE;
				});
		});

//////////////////////////////////////////////////////////////
///				main vis 																			//////
///////////////////////////////////////////////////////////////

		//globals:
		var refreshed = false;
		var index = 0;
		var dt = 750;
		var delay = 4000;
		var categories = ["elev", "Temp", "TempC", "Dewp", "Relh",
				"Winds", "SLP", "Altimeter", "Visibility", "TempHi24",
				"TempLo24", "RelhHi24", "RelhLo24", "GustHi24",
				"RawsTemp12", "RawsTemp13", "RawsTemp14", "RawsRelh12",
				"RawsRelh13", "RawsRelh14"];


		//main loop
		main();


		function main() {
			//put all the vis on the svg, make the heatmap, cycle through
			//changing opacity on the categories selected (default all)
			initializeAll();
			makeLegend();
			cycle();
			index++;
			setInterval(function() {
						if (refreshed) {
							index = 0;
							refreshed = false;
						}
						cycle();
						index++;
					}, 2*dt + delay);
		}


		function updateCategories() {
			//run when user clicks "update" - changes categories
			//list to whatever they selected, then cleans svg
			refreshed = true;
			categories = [];
			var checked = d3.selectAll("input:checked")[0];
			for (var i = 0; i < checked.length; i++){
				categories.push(checked[i].value)
			}

			cleanSVG();
		}


		function cleanSVG() {
			//make everything in the vis opaque again
			d3.selectAll("circle")
				.style("opacity", 0);

			d3.selectAll(".min-text")
				.style("opacity", 0);

			d3.selectAll(".max-text")
				.style("opacity", 0);

			d3.selectAll(".category-text")
				.style("opacity", 0);
		}


		function initializeAll() {
			//get the data and run initialize() for each category
			var dataUrl = "ba-simple-proxy/ba-simple-proxy.php?url=http://www.wrh.noaa.gov/hnx/JimBGmwXJList.php?extents=34.74,-121.4,38.36,-117.62&mode=native";
			d3.json(dataUrl, function(error, data) {
				if (error) { console.log("There was an error loading the data." + error); }

				data = data.stations;

				for (var i = 0; i < categories.length; i++) {
					initialize(data, categories[i])
				}

			});
		}


		function makeLegend() {
			//make a heatmap bar to show what the data represents
			var numRects = 100;
			var rectsData = [];
			for (var i = 0; i < numRects; i++) {
				rectsData.push(i);
			}
			var textHeight = height/15;
			var categoryTextWidth = width/4;
			var colorScale = d3.scale.linear()
					.domain([0, numRects - 1])
					.range([0, 255]);

			svg.selectAll("rect.heatmap")
					.data(rectsData)
				.enter()
					.append("rect")
					.attr("x", function(d, i) {
						return 2.2*categoryTextWidth + i*(.75*categoryTextWidth/numRects);
					})
					.attr("y", textHeight/2)
					.attr("width", categoryTextWidth/numRects)
					.attr("height", textHeight/2)
					.attr("fill", function(d) {
						var num = Math.round(colorScale(d));
						return "rgb(" + num + ", 0, " + (255 - num) + ")";
					});
		}


		function cycle() {
			//pick next data category, make it opacity 1 and the
			//one before it opacity 0 in a smooth transition
			var nextCategory = categories[index % categories.length];
			var previousCategory = categories[(index-1) % categories.length];

			svg.selectAll("#" + previousCategory)		//above
				.transition()
					.duration(dt)
					.style("opacity", 0);

			svg.selectAll("#" + nextCategory)		//below
				.transition()
					.duration(dt)
					.style("opacity", 1);
		}


		function initialize(dataFull, name) {
			//from the data, plot the heatmapped dots in their
			//coordinates and start them off opacity 0.
			//also display some text for what the colors mean
			//and what the data is about
			var min = d3.min(dataFull, function(d) {
				return +( eval("d." + name) ); //+ makes it an int, eval makes string a var
			});
			var max = d3.max(dataFull, function(d) {
				return +( eval("d." + name) );
			});

			var colorScale = d3.scale.linear()
					.domain([min, max])
					.range([0, 255]);

			// var radiusScale =	d3.scale.linear()
			// 				.domain([d3.min(dataFull, function(d) {
			// 					return +( eval("d." + name) );
			// 					}), d3.max(dataFull, function(d) {
			// 						return +( eval("d." + name) );
			// 				 	})]) //+ makes it an int, eval makes string a var
			// 				.range([2, 10]);

			//display name of category
			var textHeight = height/15;
			var categoryTextWidth = width/4;
			var text = svg.selectAll("text#" + name + ".category-text")
					.data([0]);

			text
				.enter()
					.append("text")
					.attr("class", "category-text")
					.attr("id", name)
					.attr("x", categoryTextWidth)
					.attr("y", textHeight)
					.text(name)
					.style("opacity", 0);

			text
					.text(name);

			//show a legend for the color map
			var minText = svg.selectAll("text#" + name + ".min-text")
					.data([0]);

			minText
				.enter()
					.append("text")
					.attr("class", "min-text")
					.attr("id", name)
					.attr("x", 2*categoryTextWidth)
					.attr("y", textHeight)
					.text(min)
					.style("opacity", 0);

			minText
				.text(min);

			var maxText = svg.selectAll("text#" + name + ".max-text")
					.data([0]);

			maxText
				.enter()
					.append("text")
					.attr("class", "max-text")
					.attr("id", name)
					.attr("x", 3*categoryTextWidth)
					.attr("y", textHeight)
					.text(max)
					.style("opacity", 0);

			maxText
				.text(max);

			//add data vis with class 'name' and opacity 0
			var circs = svg.selectAll("circle." + name)
					.data(dataFull);

			circs
				.enter()
					.append("circle")
					.attr("class", function(d) {
						if (eval("d." + name)) {
							return name;
						} else {
							return "undefined";
						}
					})
					.attr("id", name)
					.attr("cx", function(d) {
						return projectionFunc([d.longitude, d.latitude])[0]
					})
					.attr("cy", function(d) {
						return projectionFunc([d.longitude, d.latitude])[1]
					})
					// .attr("r", function(d) {
					// 	return radiusScale(eval("d." + name));
					// })
					.attr("r", 7)
					.attr("fill", function(d) {
						var num = Math.round(colorScale(eval("d." + name)));
						return "rgb(" + num + ", 0, " + (255 - num)+ ")";
					})
					.style("opacity", 0);

			circs
					.attr("class", function(d) {
						if (eval("d." + name)) {
							return name;
						} else {
							return "undefined";
						}
					})
					.attr("cx", function(d) {
						return projectionFunc([d.longitude, d.latitude])[0]
					})
					.attr("cy", function(d) {
						return projectionFunc([d.longitude, d.latitude])[1]
					})
					// .attr("r", function(d) {
					// 	return radiusScale(eval("d." + name));
					// })
					.attr("fill", function(d) {
						var num = Math.round(colorScale(eval("d." + name)));
						return "rgb(" + num + ", 0, " + (255 - num)+ ")";
					})
					.style("opacity", 0);

			circs
				.exit()
					.remove()

			//the ones that had no data
			svg.selectAll("circle.undefined")
					.remove();
		}


	</script>

</body>
</html>
